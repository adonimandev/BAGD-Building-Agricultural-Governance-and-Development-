<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <script src="public/bagd-lang-theme.js"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BAGD ‚Äî Farmer</title>
  <link rel="stylesheet" href="public/styles.css">
</head>
<body>
  <header class="site-header glass">
    <div class="container header-inner">
      <a href="index.html" class="brand"><span class="brand-mark">‚öú</span><span class="brand-text">BAGD</span></a>
      <nav class="nav"><a class="btn btn-secondary" href="index.html">Sign out</a></nav>
      <nav class="nav" style="display:flex; align-items:center; gap:8px;">
        <button id="themeToggle" class="icon-btn" aria-label="Toggle theme">üåô</button>
        <select id="langSelect" aria-label="Language selector" style="margin-left:8px; padding:6px; border-radius:6px;">
          <option value="en">English</option>
          <option value="am">·ä†·àõ·à≠·äõ (Amharic)</option>
          <option value="om">Afaan Oromoo (Oromo)</option>
          <option value="ti">·âµ·åç·à≠·äõ (Tigrinya)</option>
        </select>
      </nav>
    </div>
  </header>

  <main class="container">
    <section class="hero glass" style="padding:14px">
      <h1 style="margin:0 0 8px 0">Farmer dashboard</h1>
      <p class="muted" style="margin:0">Create listings, view orders, and track earnings.</p>
    </section>

    <section class="content-grid">
      <aside class="glass" style="padding:12px">
        <h2 style="margin:0 0 10px 0">Create listing</h2>
        <form id="productForm" enctype="multipart/form-data">
          <label><span>Your Name</span><input type="text" name="name" placeholder="e.g. Alemayu" required /></label>
          <div style="height:8px"></div>
          <label><span>Crop</span><input type="text" name="crop" placeholder="e.g. Maize" required /></label>
          <div style="height:8px"></div>
          <label><span>Variety</span><input type="text" name="variety" placeholder="e.g. Yellow" required /></label>
          <div style="height:8px"></div>
          <label><span>Weight (kg)</span><input type="number" name="weight" placeholder="e.g. 540" required /></label>
          <div style="height:8px"></div>
          <label><span>Price per kg (ETB)</span><input type="number" name="price" placeholder="e.g. 24" required /></label>
          <div style="height:8px"></div>
          <label><span>Harvest date</span><input type="date" name="harvest_date" required /></label>
          <div style="height:8px"></div>
          <label><span>Storage location</span><input type="text" name="storage_location" placeholder="e.g. Oromia" required /></label>
          <div style="height:12px"></div>
          <label><span>Photo</span><input type="file" name="photo" class="file-input" accept="image/*" /></label>
          <div style="height:12px"></div>
          <button type="submit" class="btn btn-primary" id="publishProduct">Publish</button>
        </form>
        <div style="height:10px"></div>
        <button class="btn btn-secondary" id="openAddProduct">Add new product (modal)</button>
      </aside>

      <section>
        <div class="cards">
          <article class="card">
            <img src="public/assets/images/placeholder_crop.svg" alt="Listing" />
            <div class="card-body">
              <h3>Maize ‚Äî 540 kg</h3>
              <p class="muted">ETB 24/kg ‚Ä¢ Oromia</p>
              <div class="actions"><button class="btn btn-secondary product-edit">Edit</button><button class="btn btn-primary product-remove">Remove</button></div>
            </div>
          </article>
          <article class="card">
            <img src="public/assets/images/placeholder_crop.svg" alt="Listing" />
            <div class="card-body">
              <h3>Teff ‚Äî 320 kg</h3>
              <p class="muted">ETB 52/kg ‚Ä¢ Amhara</p>
              <div class="actions"><button class="btn btn-secondary product-edit">Edit</button><button class="btn btn-primary product-remove">Remove</button></div>
            </div>
          </article>
        </div>

        <div style="height:16px"></div>
        <div class="lass" style="padding:12px">
          <h2 style="margin:0 0 8px 0">Incoming orders</h2>
          <table class="table">
            <thead><tr><th>Order</th><th>Buyer</th><th>Qty</th><th>Total</th><th>Status</th><th>Action</th></tr></thead>
            <tbody>
              <tr><td>#1024</td><td>Biruk</td><td>50 kg</td><td>ETB 1,200</td><td>placed</td><td><button class="btn btn-primary">Accept</button></td></tr>
              <tr><td>#1025</td><td>Selam</td><td>20 kg</td><td>ETB 480</td><td>placed</td><td><button class="btn btn-secondary">Cancel</button></td></tr>
            </tbody>
          </table>
        </div>

        <div style="height:16px"></div>
        <div class="glass" style="padding:12px;display:grid;grid-template-columns:repeat(3,1fr);gap:12px">
          <div class="stat"><div class="stat-num">ETB 12,400</div><div class="stat-label">Total earnings</div></div>
          <div class="stat"><div class="stat-num">7</div><div class="stat-label">Active listings</div></div>
          <div class="stat"><div class="stat-num">4.8‚òÖ</div><div class="stat-label">Rating</div></div>
        </div>

        <div style="height:16px"></div>
      <div class="glass" style="padding:12px">
  <h2>Delivery requests</h2>
  <div class="muted">Request a pickup from your storage to buyer dropoff.</div>
  <div style="height:10px"></div>
  <input type="text" id="order_id" placeholder="Order ID">
  <input type="text" id="pickup_location" placeholder="Pickup location">
  <input type="text" id="dropoff_location" placeholder="Dropoff location">
  <button class="btn btn-primary" id="requestPickupBtn">Request hauler pickup</button>
</div>

        <div style="height:16px"></div>
        <div class="glass" style="padding:12px">
          <h2 style="margin:0 0 8px 0">Sales history</h2>
          <table class="table">
            <thead><tr><th>Date</th><th>Product</th><th>Qty</th><th>Amount</th></tr></thead>
            <tbody>
              <tr><td>2025-06-01</td><td>Maize</td><td>80 kg</td><td>ETB 1,920</td></tr>
              <tr><td>2025-05-30</td><td>Teff</td><td>40 kg</td><td>ETB 2,080</td></tr>
            </tbody>
          </table>
        </div>

        <div style="height:16px"></div>
        <div class="glass" style="padding:12px">
          <h2 style="margin:0 0 8px 0">Earnings & payouts</h2>
          <div style="display:flex;align-items:center;justify-content:space-between">
            <div><div class="muted">Current balance</div><div class="stat-num">ETB 4,820</div></div>
            <button class="btn btn-primary" id="openWithdraw">Withdraw</button>
          </div>
          <div style="height:10px"></div>
          <h3 style="margin:0 0 8px 0">Payout history</h3>
          <table class="table">
            <thead><tr><th>Date</th><th>Method</th><th>Amount</th><th>Status</th></tr></thead>
            <tbody>
              <tr><td>2025-05-28</td><td>Telebirr</td><td>ETB 2,000</td><td>paid</td></tr>
            </tbody>
          </table>
          <div style="height:12px"></div>
          <h3 style="margin:0 0 8px 0">Payout settings</h3>
          <label><span>Bank or Mobile Money</span><input type="text" placeholder="Telebirr / Bank Account" /></label>
          <div style="height:10px"></div>
          <button class="btn btn-primary">Save</button>
        </div>


      </section>
    </section>
  </main>

  <!-- Modals -->
  <div class="modal" id="modalAddProduct" aria-hidden="true">
    <div class="modal-card">
      <div class="modal-header"><strong>Add Product</strong><button class="close-btn" data-close="modalAddProduct">√ó</button></div>
      <div class="modal-body">
        <label><span>Crop</span><input type="text" placeholder="Maize"/></label>
        <div style="height:8px"></div>
        <label><span>Weight (kg)</span><input type="number" placeholder="100"/></label>
        <div style="height:8px"></div>
        <label><span>Price per kg</span><input type="number" placeholder="24"/></label>
        <div style="height:8px"></div>
        <label><span>Location</span><input type="text" placeholder="Oromia"/></label>
        <div style="height:8px"></div>
        <label><span>Photo</span><input type="file"/></label>
        <div style="height:12px"></div>
        <button class="btn btn-primary" id="addProductConfirm">Add</button>
      </div>
    </div>
  </div>

  <div class="modal" id="modalRequestPickup" aria-hidden="true">
    <div class="modal-card">
      <div class="modal-header"><strong>Request Pickup</strong><button class="close-btn" data-close="modalRequestPickup">√ó</button></div>
      <div class="modal-body">
        <label><span>Order ID</span><input type="text" placeholder="#1024"/></label>
        <div style="height:8px"></div>
        <label><span>Pickup location</span><input type="text" placeholder="Oromia storage"/></label>
        <div style="height:8px"></div>
        <label><span>Dropoff location</span><input type="text" placeholder="Addis buyer"/></label>
        <div style="height:12px"></div>
        <button class="btn btn-primary" id="requestPickupConfirm">Request</button>
      </div>
    </div>
  </div>

  <div class="modal" id="modalWithdraw" aria-hidden="true">
    <div class="modal-card">
      <div class="modal-header"><strong>Withdraw</strong><button class="close-btn" data-close="modalWithdraw">√ó</button></div>
      <div class="modal-body">
        <label><span>Amount (ETB)</span><input type="number" placeholder="1000"/></label>
        <div style="height:8px"></div>
        <label><span>Method</span>
          <select><option>Telebirr</option><option>Bank</option></select>
        </label>
        <div style="height:12px"></div>
        <button class="btn btn-primary" id="withdrawConfirm">Withdraw</button>
      </div>
    </div>
  </div>
  <!-- Edit Product Modal -->
<div class="modal" id="modalEditProduct" aria-hidden="true">
    <div class="modal-card">
        <div class="modal-header">
            <strong>Edit Product</strong>
            <button class="close-btn" data-close="modalEditProduct">√ó</button>
        </div>
        <div class="modal-body">
            <form id="editProductForm">
                <input type="hidden" id="editProductId" name="id">
                <label><span>Crop</span><input type="text" id="editCrop" name="crop" required></label>
                <div style="height:8px"></div>
                <label><span>Variety</span><input type="text" id="editVariety" name="variety" required></label>
                <div style="height:8px"></div>
                <label><span>Weight (kg)</span><input type="number" id="editWeight" name="weight" required></label>
                <div style="height:8px"></div>
                <label><span>Price per kg (ETB)</span><input type="number" id="editPrice" name="price" required></label>
                <div style="height:8px"></div>
                <label><span>Harvest date</span><input type="date" id="editHarvestDate" name="harvest_date" required></label>
                <div style="height:8px"></div>
                <label><span>Storage location</span><input type="text" id="editStorageLocation" name="storage_location" required></label>
                <div style="height:12px"></div>
                <button type="submit" class="btn btn-primary">Update Product</button>
            </form>
        </div>
    </div>
</div>
  <!-- Notification -->
  <div class="notification" id="notification">
    <span class="notification-icon" id="notificationIcon">‚ÑπÔ∏è</span>
    <span id="notificationMessage">Notification message</span>
  </div>

  <script>
document.addEventListener('DOMContentLoaded', function() {

    // ===========================
    // Notification Function
    // ===========================
    function showNotification(message, type = 'info') {
        const notification = document.getElementById('notification');
        const messageEl = document.getElementById('notificationMessage');

        if(!notification || !messageEl) return;

        messageEl.textContent = message;
        notification.className = 'notification ' + type;
        notification.classList.add('show');

        setTimeout(() => {
            notification.classList.remove('show');
        }, 3000);
    }

    // ===========================
    // Product Form Submission
    // ===========================
    const productForm = document.getElementById('productForm');
    if(productForm){
        productForm.addEventListener('submit', function(e){
            e.preventDefault();
            const formData = new FormData(this);
            const publishBtn = document.getElementById('publishProduct');
            const originalText = publishBtn.textContent;

            publishBtn.textContent = 'Publishing...';
            publishBtn.disabled = true;

            fetch('farmer.php', {
                method: 'POST',
                body: formData
            })
            .then(res => res.json())
            .then(data => {
                if(data.success){
                    showNotification('Product published successfully!', 'success');
                    this.reset();
                    loadFarmerProducts();
                } else {
                    showNotification('Error: ' + data.message, 'error');
                }
            })
            .catch(err => showNotification('Network error: ' + err.message, 'error'))
            .finally(() => {
                publishBtn.textContent = originalText;
                publishBtn.disabled = false;
            });
        });
    }

    // ===========================
    // Modals Handling
    // ===========================
    document.querySelectorAll('[data-close]').forEach(button => {
        button.addEventListener('click', function(){
            const modalId = this.getAttribute('data-close');
            const modal = document.getElementById(modalId);
            if(modal) modal.style.display = 'none';
        });
    });

    // Open modal buttons
    ['AddProduct', 'RequestPickup', 'Withdraw'].forEach(id => {
        const btn = document.getElementById('open' + id);
        const modal = document.getElementById('modal' + id);
        if(btn && modal){
            btn.addEventListener('click', () => modal.style.display = 'flex');
        }
    });

    // Close modals on clicking outside
    document.querySelectorAll('.modal').forEach(modal => {
        modal.addEventListener('click', function(e){
            if(e.target === this) this.style.display = 'none';
        });
    });

    // ===========================
    // Request Pickup
    // ===========================
    const pickupBtn = document.getElementById('requestPickupBtn');
    if(pickupBtn){
        pickupBtn.addEventListener('click', function(){
            const order_id = document.getElementById('order_id')?.value;
            const pickup = document.getElementById('pickup_location')?.value;
            const dropoff = document.getElementById('dropoff_location')?.value;

            if(!order_id || !pickup || !dropoff){
                alert('Please fill all fields.');
                return;
            }

            fetch('request_pickup.php', {
                method: 'POST',
                headers: { 'Content-Type':'application/x-www-form-urlencoded' },
                body: `order_id=${encodeURIComponent(order_id)}&pickup=${encodeURIComponent(pickup)}&dropoff=${encodeURIComponent(dropoff)}`
            })
            .then(res => res.json())
            .then(data => {
                alert(data.message);
                if(data.success){
                    document.getElementById('order_id').value = '';
                    document.getElementById('pickup_location').value = '';
                    document.getElementById('dropoff_location').value = '';
                }
            })
            .catch(err => alert('Network error: ' + err.message));
        });
    }

    // ===========================
    // Theme Toggle
    // ===========================
    const themeToggle = document.getElementById('themeToggle');
    const prefersDarkScheme = window.matchMedia('(prefers-color-scheme: dark)');

    if(themeToggle){
        if(localStorage.getItem('theme') === 'dark' || (!localStorage.getItem('theme') && prefersDarkScheme.matches)){
            document.body.classList.add('dark-theme');
            themeToggle.textContent = '‚òÄÔ∏è';
        } else {
            themeToggle.textContent = 'üåô';
        }

        themeToggle.addEventListener('click', function(){
            document.body.classList.toggle('dark-theme');
            const isDark = document.body.classList.contains('dark-theme');
            themeToggle.textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
        });
    }

    // ===========================
    // Language Selector
    // ===========================
    const langSelect = document.getElementById('langSelect');
    if(langSelect){
        langSelect.addEventListener('change', function(){
            showNotification('Language changed to ' + this.options[this.selectedIndex].text, 'info');
        });
    }

    // ===========================
    // Product Edit & Remove (Delegated)
    // ===========================
    document.addEventListener('click', function(e){
        if(e.target.classList.contains('product-edit')){
            const productId = e.target.getAttribute('data-id');
            editProduct(productId);
        }
        if(e.target.classList.contains('product-remove')){
            const productId = e.target.getAttribute('data-id');
            removeProduct(productId);
        }
    });

    // ===========================
    // Registration Success Modal
    // ===========================
    const urlParams = new URLSearchParams(window.location.search);
    if(urlParams.get('registered') === 'true'){
        const modal = document.createElement('div');
        modal.innerHTML = `
        <div style="position:fixed; top:0; left:0; width:100%; height:100%; 
                    background:rgba(0,0,0,0.5); display:flex; align-items:center; 
                    justify-content:center; z-index:10000;">
            <div style="background:white; padding:20px; border-radius:8px; 
                        text-align:center; max-width:400px; box-shadow:0 4px 12px rgba(0,0,0,0.2);">
                <h2 style="color:#2c5aa0; margin-top:0;">Registration Successful!</h2>
                <p>Welcome to BAGD Farmer Dashboard. You can now start listing your products.</p>
                <button style="background:#2c5aa0; color:white; border:none; padding:10px 20px; 
                            border-radius:6px; cursor:pointer; margin-top:15px;" 
                        onclick="this.parentElement.parentElement.remove()">
                    Get Started
                </button>
            </div>
        </div>`;
        document.body.appendChild(modal);
        const newUrl = window.location.protocol + "//" + window.location.host + window.location.pathname;
        window.history.replaceState({}, document.title, newUrl);
    }

    // ===========================
    // Load Farmer Products
    // ===========================
    function loadFarmerProducts(){
        fetch('get_products.php')
        .then(res => res.json())
        .then(data => {
            if(data.success){
                displayProducts(data.products);
            } else {
                console.error('Error loading products:', data.message);
            }
        })
        .catch(err => console.error('Network error:', err));
    }

    function displayProducts(products){
        const cardsContainer = document.querySelector('.cards');
        if(!cardsContainer) return;
        cardsContainer.innerHTML = '';
        products.forEach(product => {
            cardsContainer.appendChild(createProductCard(product));
        });
    }

    function createProductCard(product){
        const article = document.createElement('article');
        article.className = 'card';
        const gradient = getGradientForCrop(product.crop);
        article.innerHTML = `
            <div style="height:160px; background: ${gradient};"></div>
            <div class="card-body">
                <h3>${product.crop} (${product.variety})</h3>
                <p class="muted">${product.storage_location} ‚Ä¢ ${product.weight} kg available</p>
                <div class="price">ETB ${product.price} / kg</div>
                <div class="actions">
                    <button class="btn btn-secondary product-edit" data-id="${product.id}">Edit</button>
                    <button class="btn btn-primary product-remove" data-id="${product.id}">Remove</button>
                </div>
            </div>`;
        return article;
    }

    function getGradientForCrop(crop){
        const gradients = {
            'Maize': 'linear-gradient(45deg, #4caf50, #8bc34a)',
            'Teff': 'linear-gradient(45deg, #795548, #9e9e9e)',
            'Wheat': 'linear-gradient(45deg, #ffd54f, #fff176)',
            'Coffee': 'linear-gradient(45deg, #6d4c41, #a1887f)',
            'Barley': 'linear-gradient(45deg, #d7ccc8, #bcaaa4)',
            'Sorghum': 'linear-gradient(45deg, #8d6e63, #bdbdbd)',
            'Chickpea': 'linear-gradient(45deg, #ffb74d, #ffcc80)'
        };
        return gradients[crop] || 'linear-gradient(45deg, #36d399, #28a07f)';
    }

    // ===========================
    // Edit & Remove Product Functions
    // ===========================
    function editProduct(productId){
        fetch(`get_product.php?id=${productId}`)
        .then(res => res.json())
        .then(data => {
            if(data.success){
                openEditModal(data.product);
            } else alert('Error loading product: ' + data.message);
        })
        .catch(err => console.error('Network error:', err));
    }

    function removeProduct(productId){
        if(confirm('Are you sure you want to remove this product?')){
            fetch('delete_product.php', {
                method: 'POST',
                headers: { 'Content-Type':'application/json' },
                body: JSON.stringify({ id: productId })
            })
            .then(res => res.json())
            .then(data => {
                if(data.success){
                    alert('Product removed successfully!');
                    loadFarmerProducts();
                } else alert('Error removing product: ' + data.message);
            })
            .catch(err => console.error('Network error:', err));
        }
    }

    function openEditModal(product){
        document.getElementById('editProductId').value = product.id;
        document.getElementById('editCrop').value = product.crop;
        document.getElementById('editVariety').value = product.variety;
        document.getElementById('editWeight').value = product.weight;
        document.getElementById('editPrice').value = product.price;
        document.getElementById('editHarvestDate').value = product.harvest_date;
        document.getElementById('editStorageLocation').value = product.storage_location;
        document.getElementById('modalEditProduct').style.display = 'flex';
    }

    // Load products initially
    loadFarmerProducts();

});
</script>

</body>
</html>